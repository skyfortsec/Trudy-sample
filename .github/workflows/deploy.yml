name: Deploy Static Website to GKE

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ vars.GCP_PROJECT }}
          install_components: gke-gcloud-auth-plugin

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.7

      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init

      - name: Terraform Apply (Create/Update GKE + Artifact Registry)
        working-directory: ./terraform
        run: |
          PROJECT_ID="$(printf "%s" "${{ vars.GCP_PROJECT }}" | tr -d '\r\n\t' | xargs)"
          REGION="$(printf "%s" "${{ vars.GKE_REGION }}" | tr -d '\r\n\t' | xargs)"
          ZONE="$(printf "%s" "${{ vars.GCP_ZONE }}" | tr -d '\r\n\t' | xargs)"
          CLUSTER_NAME="$(printf "%s" "${{ vars.GKE_CLUSTER_NAME }}" | tr -d '\r\n\t' | xargs)"

          terraform apply -auto-approve \
            -var="project_id=${PROJECT_ID}" \
            -var="region=${REGION}" \
            -var="zone=${ZONE}" \
            -var="cluster_name=${CLUSTER_NAME}"

      - name: Configure Docker auth for Artifact Registry
        run: |
          REGION="$(printf "%s" "${{ vars.GKE_REGION }}" | tr -d '\r\n\t' | xargs)"
          gcloud auth configure-docker "${REGION}-docker.pkg.dev" --quiet

      - name: Build & Push Docker image
        run: |
          PROJECT_ID="$(printf "%s" "${{ vars.GCP_PROJECT }}" | tr -d '\r\n\t' | xargs)"
          REGION="$(printf "%s" "${{ vars.GKE_REGION }}" | tr -d '\r\n\t' | xargs)"
          REPO="$(printf "%s" "${{ vars.AR_REPO }}" | tr -d '\r\n\t' | xargs)"

          IMAGE="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/static-website:${GITHUB_SHA}"

          docker build -t "${IMAGE}" .
          docker push "${IMAGE}"

          echo "IMAGE=${IMAGE}" >> $GITHUB_ENV

      - name: Get GKE credentials
        run: |
          PROJECT_ID="$(printf "%s" "${{ vars.GCP_PROJECT }}" | tr -d '\r\n\t' | xargs)"
          ZONE="$(printf "%s" "${{ vars.GCP_ZONE }}" | tr -d '\r\n\t' | xargs)"
          CLUSTER_NAME="$(printf "%s" "${{ vars.GKE_CLUSTER_NAME }}" | tr -d '\r\n\t' | xargs)"

          gcloud container clusters get-credentials "${CLUSTER_NAME}" --zone "${ZONE}" --project "${PROJECT_ID}"

      - name: Deploy to Kubernetes
        run: |
          # Replace image placeholder and apply manifests
          sed "s|IMAGE_PLACEHOLDER|${IMAGE}|g" k8s/deployment.yaml | kubectl apply -f -
          kubectl apply -f k8s/service.yaml

      - name: Get Service External IP
        run: |
          echo "Waiting for LoadBalancer external IP..."
          kubectl get svc static-website-svc -w
